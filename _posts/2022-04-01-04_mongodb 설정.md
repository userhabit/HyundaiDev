---
title: "04_mongodb 설정"
date: 2022-04-01 00:00:00 +0900
layout: article
tag: 
- HyundaiDev
categories: 
- Development
- InstallGuide
published: true
---
## mongodb 설정

### 설치된 mongodb-org-5.0.5-1.el8.x86_64.rpm 의 설정

> 설정순서
> 
1. /etc/mongod.conf 수정
2. /etc/hosts 에 domain 추가
3. /var/log/mongodb/mongod.log 에 대한 other 의 읽기권한 추가
4. 몽고db 실행
5. replicaSet 설정  
6. 재실행테스트
7. user 생성(polaris) *본 페이지에서는 제외

### mongod.conf 수정

> CMD - 설정에서 사용할 directory 생성
> 

```
mkdir -p /mceadm/apps/mongo/data
mkdir -p /mceadm/apps/mongo/log
chmod 755 /mceadm/apps
chmod 755 /mceadm/apps/mongo
chown mceadm:hmc /mceadm/apps/mongo
chown mongod:mongod /mceadm/apps/mongo/data
chown mongod:mongod /mceadm/apps/mongo/log
```

> CMD -  `/etc/mongod.conf` 에 다음 사항을 추가
> 

```
replication:
   replSetName: "rs0"
net:
   bindIp: localhost,<hostname(s)|ip address(es)>
```

```
# mongod.conf in "uhs1.userhabit.io"

# Where and how to store data.
storage:
  dbPath: /mceadm/apps/mongo/data
  journal:
    enabled: true

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /mceadm/apps/mongo/log/mongod.log

# network interfaces
net:
  port: 27017
  bindIp: 127.0.0.1,uhs1.userhabit.io

# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

# auth - 계정을 먼저 만들고 활성화 해야 한다.
# security:
#  authorization: enabled
#  keyFile: /var/lib/mongo/replica_set_key

replication:
   replSetName: "rs0"
```

### /etc/hosts file 에 domain 추가

> CMD
> 

```
echo -e "10.227.171.96  uhs1.userhabit.io\n10.227.171.97 \
uhs1.userhabit.io\n10.227.171.98  uhs1.userhabit.io\n" >> /etc/hosts
```

### /var/log/mongodb/mongod.log 에 대한 other 의 읽기권한 추가

> CMD
> 

```
chmod o+r /var/log/mongodb/mongod.log
```

### 몽고db 실행

- root 계정 필요
- 매주 서버 하드웨어 리부팅을 위해 systemctl을 이용해서 자동 재시작 할 수 있도록 설정
- 참고 :  [How to run MongoDB as a non root user in Linux? - Database Administrators Stack Exchange](https://dba.stackexchange.com/questions/132544/how-to-run-mongodb-as-a-non-root-user-in-linux)

> CMD
> 

```
systemctl start mongod
```

> 참고
> 
- 정상적으로 RPM을 통한 설치가 진행되면 아래 두 가지가 생성된다.

```
-rw-r--r-- 1 root root /usr/lib/systemd/system/mongod.service
-rw-r--r-- 1 root root /etc/mongod.conf
```

- **/etc/mongod.conf** 를 보면, 기본 path 로 다음 2가지를 쓰고 있는 것을 알 수 있다.
- dbPath : /var/lib/mongo
- log : /var/log/mongod/mongod.log

```
drwxr-xr-x 2 mongod mongod /var/log/mongod
drwxrw-rw- 1 mongod mongod /var/lib/mongo
srwx------ 1 mongod mongod /tmp/mongodb-27017.sock
```

### replicaSet 설정 및 재시작 테스트

1. 3개의 서버 내 mongodb 를 전부 실행한 후 한 곳에 가서 mongo로 접속한다. 
2. 이후 rs.initiate() 로 replicaSet 설정을 진행한다. 
3. 설정 확인은 rs.status() 진행한다. 

```
$ mongo

...

> rs.initiate( {
       _id : "rs0",
       members: [
          { _id: 0, host: "uhs1.userhabit.io:27017" },
          { _id: 1, host: "uhs2.userhabit.io:27017" },
          { _id: 2, host: "uhs3.userhabit.io:27017" }
       ]
    })
...

> rs.status()
```

1. priority 설정이 없기 때문에 3개 중 한개가 primary node로 설정된다.  띄우는 순서와 관계가 없으며 재실행 하면 primary 가 바뀔 수 있지만 원 동작구조가 이러한 방식이기 때문에 성능 및 정상동작 여부와는 아무런 관계가 없다.

### 재실행테스트

- 현재까지 설정이 완료되면 실행된 3개의 서버내 mongodb는 어떤 방식으로 shutdown 및 restart를 실행하여도 아무런 문제가 없다.
- ex) 전체를 내리고 다시 start : ok / 하나를 내린후 상태 : ok