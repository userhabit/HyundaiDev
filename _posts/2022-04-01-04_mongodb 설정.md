---
title: "04_mongodb 설정"
date: 2022-04-01 03:00:00
layout: article
tag: 
- HyundaiDev
categories: 
- Development
- InstallGuide
published: true
excerpt: '설치된 mongodb의 설정 및 클러스트링을 설정합니다.'
---
## mongodb 설정

### 설치된 mongodb-org-5.0.5-1.el8.x86_64.rpm 의 설정


> 설정순서
> 
1. /etc/mongod.conf 수정
2. /etc/hosts 에 domain 추가
3. /var/log/mongodb/mongod.log 에 대한 other 의 읽기권한 추가
4. 몽고db 실행
5. replicaSet 설정  
6. auth 설정
7. 기타

### mongod.conf 수정
1. 설정에서 사용할 directory 생성
> CMD
> 

```
mkdir -p /mceadm/apps/mongo/data
mkdir -p /mceadm/apps/mongo/log
chmod 755 /mceadm/apps
chmod 755 /mceadm/apps/mongo
chown mceadm:hmc /mceadm/apps/mongo
chown mongod:mongod /mceadm/apps/mongo/data
chown mongod:mongod /mceadm/apps/mongo/log
```

2. `/etc/mongod.conf` 에 다음 사항을 추가
> CMD
> 

```
replication:
   replSetName: "rs0"
net:
   bindIp: localhost,<hostname(s)|ip address(es)>
```

```
# mongod.conf in "uhs1.userhabit.io"

# Where and how to store data.
storage:
  dbPath: /mceadm/apps/mongo/data
  journal:
    enabled: true

# where to write logging data.
systemLog:
  destination: file
  logAppend: true
  path: /mceadm/apps/mongo/log/mongod.log

# network interfaces
net:
  port: 27617
  bindIp: 127.0.0.1,uhs1.userhabit.io


# how the process runs
processManagement:
  timeZoneInfo: /usr/share/zoneinfo

# auth - 계정을 먼저 만들고 활성화 해야 한다.
# security:
#  authorization: enabled
#  keyFile: /var/lib/mongo/replica_set_key

replication:
   replSetName: "rs0"
```

### /etc/hosts file 에 domain 추가

> CMD
> 

```
echo -e "10.227.171.96  uhs1.userhabit.io\n10.227.171.97 \
uhs1.userhabit.io\n10.227.171.98  uhs1.userhabit.io\n" >> /etc/hosts
```

### /var/log/mongodb/mongod.log 에 대한 other 의 읽기권한 추가

> CMD
> 

```
chmod o+r /var/log/mongodb/mongod.log
```

### 몽고db 실행

- root 계정 필요
- systemctl을 이용해서 서버 재부팅시 자동으로 재시작 할 수 있도록 설정
- 참고 :  [How to run MongoDB as a non root user in Linux? - Database Administrators Stack Exchange](https://dba.stackexchange.com/questions/132544/how-to-run-mongodb-as-a-non-root-user-in-linux)

> CMD
> 

```
systemctl start mongod
```

#### ※ 참고
>

- 정상적으로 RPM을 통한 설치가 진행되면 아래 두 가지가 생성된다.

```
-rw-r--r-- 1 root root /usr/lib/systemd/system/mongod.service
-rw-r--r-- 1 root root /etc/mongod.conf
```

- **/etc/mongod.conf** 를 보면, 기본 path 로 다음 2가지를 쓰고 있는 것을 알 수 있다.
- dbPath : /var/lib/mongo
- log : /var/log/mongod/mongod.log

```
drwxr-xr-x 2 mongod mongod /var/log/mongod
drwxrw-rw- 1 mongod mongod /var/lib/mongo
srwx------ 1 mongod mongod /tmp/mongodb-27017.sock
```

### replicaSet 설정 및 재시작 테스트

1. 3개의 서버 내 mongodb 를 전부 실행한 후 한 곳에 가서 mongo로 접속한다. 
2. 이후 rs.initiate() 로 replicaSet 설정을 진행한다. 
3. 설정 확인은 rs.status() 진행한다. 

```
$ mongo

...

> rs.initiate( {
       _id : "rs0",
       members: [
          { _id: 0, host: "uhs1.userhabit.io:27017" },
          { _id: 1, host: "uhs2.userhabit.io:27017" },
          { _id: 2, host: "uhs3.userhabit.io:27017" }
       ]
    })
...

> rs.status()
```

#### ※ 참고 
- 설치 서버의 종류에 따라 Port번호 변경 필요 
  - 운영: 27617
  - 개발: 27917

- priority 설정이 없기 때문에 3개 중 한개가 primary node로 설정된다.  띄우는 순서와 관계가 없으며 재실행 하면 primary 가 바뀔 수 있지만 원 동작구조가 이러한 방식이기 때문에 성능 및 정상동작 여부와는 아무런 관계가 없다.
- 재실행테스트
  - 설정이 완료되면 실행된 3개의 서버 내 mongodb는 어떤 방식으로 shutdown 및 restart를 실행하여도 아무런 문제가 없다.
  - ex) 전체를 내리고 다시 start : ok / 하나를 내린후 상태 : ok

### auth 설정 - 작성중
## mongo db auth 설정


### 1. admin 계정 생성

3개 계정 생성함. 암호는 @namhpro 에게 문의

- `root` 이 모든 권한을 가지고 있다.
- `polaris`:  web server에서 사용할 id/pw 이다. auth db 가 'userhabit' 이다.

```js
use admin
db.createUser(
  {
    user: "admin",
    pwd: passwordPrompt(),
    roles: [{role: "dbAdminAnyDatabase", db: "admin"}],
  }
)

db.createUser(
  {
    user: "root",
    pwd: passwordPrompt(),
    roles: [{role: "root", db: "admin"}],
  }
)

use userhabit
db.createUser(
  {
    user: "polaris",
    pwd: passwordPrompt(),
    roles: [ { role: "readWrite", db: "userhabit" }],
  }
)

```


### 2. mongodb node 의 priority 조정

- 작업중에 master가 `52.79.171.105`로 바뀌어서, 다시 `3.34.51.90`로 돌리기 위해서 priority 조정을 했다.
- `3.34.51.90`server의 mongodb 의 priority 를 `2` 로 올렸다.
    - 참고: [Adjust Priority for Replica Set Member — MongoDB Manual](https://www.mongodb.com/docs/v5.0/tutorial/adjust-replica-set-member-priority/#procedure)

```
cfg = rs.conf()
cfg.members[0].priority = 2
rs.reconfig(cfg)
```


### 3. `replica_set_key` 생성


아래처럼 `replica_set_key` 파일을 생성하고, 3개의 서버에 다 copy 해서 올렸다.(3개의 node가 같은 key 를 쓰는 것)


```
$ openssl rand -base64 756 > ~/polaris/mongodb/replica_set_key
$ chmod 400 ~/polaris/mongodb/replica_set_key
```


### 4. mongodb 를 `--auth` 로 실행

`mongodb-start.sh` 에 parameter 추가

- `--auth`
- `--keyFile ~/polaris/mongodb/replica_set_key`


```
# mongodb-start.sh
sh -c "cd ~/polaris/mongodb; bin/mongod --auth --keyFile ~/polaris/mongodb/replica_set_key --bind_ip localhost,ss3.userhabit.io --port 27017 --dbpath /home/ec2-user/polaris/volume/mongodb-db/ --replSet rs1 --logpath /home/ec2-user/polaris/volume/mongodb-log/mongod.log --logappend --fork &"
```


### 5. web server에서 mongodb 접속시 id/pw 를 사용하도록 수정

- https://bitbucket.org/andbut/polaris/commits/0ce1961a1b91a582ee24581f84a31262104aead8
    - 접속시에 id/pw 를 이용하도록 수정
    - auth.keys 에 `mongodb.id`, `mongodb.pw` 를 추가


## 참고

1. [mongodb replica set 설정 절차](https://i5on9i.blogspot.com/2022/01/db-mongodb-replica-set.html)





### 기타 - 작성중
mongodb collection initialization
폴라리스 서버를 처음 실행하면 collection 들을 자동으로 만든다.

그래서 일단 replcaSet 의 primary 가 있는 서버에서 polaris 를 실행했다. (참고)

primary node 에서 collection 들을 확인하면, 생성이 되어 있다. secondary node 도 확인했는데, 동기화가 잘 되었다.



```
mongo
...
rs0:PRIMARY> use userhabit;
rs0:PRIMARY> show collections;
...
rs0:SECONDARY> rs.secondaryOk();
rs0:SECONDARY> show collections;
```

rs.secondaryOk()
Secondary node 에서 query 를 할 때는 rs.secondaryOk() 를 미리 해줘야 한다. 이 명령은 session 당 한번만 하면 된다.

https://stackoverflow.com/questions/8990158/mongodb-replicates-and-error-err-not-master-and-slaveok-false-code#8990428
'mceadm' 을 mongod 그룹에 추가
mongodb log 확인을 위해 'mceadm' 을 mongod 그룹에 추가
```
usermod -a -G mongod mceadm
```
