---
title: "06_Nginx설치 및 보안설정"
date: 2022-04-01 06:00:00
layout: article
tag: 
- HyundaiDev
categories: 
- Development
- InstallGuide
published: true
excerpt: 'Nginx설치 및 보안설정'
---
## Nginx설치 및 보안설정

### Nginx의 설치

1.  rpm으로 nginx를 설치한다. 

> CMD
> 

```
rpm -Uvh nginx-1.20.2-1.el8.ngx.x86_64.rpm
```

1. 설치가 완료되면 아래와 같은 상태가 된다. 
    1. nginx 가 설치됨
    2. nginx 계정 생성됨
    3. nginx.service 등록됨
    
2. 설치를 확인한다

> CMD
> 

```
systemctl status nginx
systemctl start nginx
systemctl stop nginx
```

### Nginx관련 보안설정

1. root 계정으로 진행필요

> CMD
> 

```
# nginx:nginx (user:group) 가 존재

cat hosts >> /etc/hosts
cp nginx.conf /etc/nginx/nginx.conf

useradd nginx
usermod -s /sbin/nologin nginx

chown nginx:nginx /usr/share/nginx/html
chmod 750 /usr/share/nginx/html

chown nginx:nginx /etc/nginx/*.conf 
chmod 600 /etc/nginx/*.conf

mv /usr/share/nginx/html/index.html /usr/share/nginx/html/uh_main.html

chown nginx:nginx /var/log/nginx/
chmod 750 /var/log/nginx/ 
chmod 640 /var/log/nginx/*.log

# header filter module
cp /mceadm/install/ngx_http_headers_more_filter_module.so /etc/nginx/modules/
chmod 644 /etc/nginx/modules/ngx_http_headers_more_filter_module.so

# https 인증서
cp /mceadm/install/hmsec_pem.pem /etc/nginx/
cp /mceadm/install/hmsec_pem.key /etc/nginx/
chmod 644 /etc/nginx/hmsec_pem.pem
chmod 644 /etc/nginx/hmsec_pem.key

systemctl start nginx
systemctl status nginx
```

1. `/etc/nginx/nginx.conf` 의 수정

> CMD
> 

```
sudo usermod -aG mceadm nginx

mkdir -p /mceadm/apps/nginx/log 
mkdir -p /mceadm/apps/nginx/run 
chown nginx:nginx /mceadm/apps/nginx -R
```

```
# /etc/nginx/nginx.conf
user nginx nginx;

worker_processes auto;

error_log /mceadm/apps/nginx/log/error.log notice; 
pid /var/run/nginx.pid;

# ###############
# ngx_http_headers_more_filter_module
# ###############
load_module /etc/nginx/modules/ngx_http_headers_more_filter_module.so;

events { 
  worker_connections 1024; 
}

http{

  include         /etc/nginx/mime.types; 
  default_type application/octet-stream;

  # ###############
  # ngx_http_headers_more_filter_module
  # ###############
  more_set_headers 'Server: Userhabit';
  more_set_headers 'X-Powered-By: Userhabit, Inc.';

  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                ' ""$http_user_agent" "$http_x_forwarded_for"';

  access_log /mceadm/apps/nginx/log/access.log main;

  sendfile on; 
  #tcp_nopush on;

  keepalive_timeout 65;

  #gzip on;
  
  client_max_body_size 50m;

  include /etc/nginx/conf.d/*.conf;

  server {
    listen 90;
    return 301 https://mceex.hmsec.com; # 개발서버는 mceext.hmsec.com
  }
  server {
    # ####################
    # 수정필요 : 추후 domain 이 설정되면 변경
    # ####################
    listen 443 ssl;
    server_name mceex.hmsec.com; # 개발서버는 mceext.hmsec.com
    ssl_certificate /etc/nginx/hmsec_pem.pem; 
    ssl_certificate /etc/nginx/hmsec_pem.key
    ssl_protocols TLSV1 TLSv1.1 TLSV1.2; 
    ssl_ciphers HIGH:!aNULL:!MD5;

    # listen 80;
    # server_name localtest

    #hmse 
    server_tokens off;
    
    error_page 400 401 403 404 500 502 503 504 /50x.html;
    location / { 
      root /usr/share/nginx/html;  
      index uh_main.html uh_main.htm;

      autoindex off;

      dav_methods PUT DELETE MKCOL COPY MOVE;

    }

    location /v3 {
      proxy_pass http://polaris;
    }
    location /v2 {
     proxy_pass http://polaris;

    }

  } 

  upstream polaris {
    # ####################
    # 수정필요 : 추후 dmz 에서 현대차증권 local gateway 가 열리면 변경
    # ####################
    server uhs1.userhabit.io:8080;
    server uhs2.userhabit.io:8080;
    server uhs3.userhabit.io:8080;
    # server 127.0.0.1:8080;
  }
}
```

1. `/etc/hosts` 의 수정

> CMD
> 

```
...
10.227.171.96 uhs1.userhabit.io
10.227.171.97 uhs2.userhabit.io
10.227.171.98 uhs3.userhabit.io
```

1. 동작테스트(중간)
- local test server open (using port 8080)
- curl 명령어를 통한 확인

> CMD
> 

```
python3 -m http.server 8080
```

```
curl localhost
curl localhost/v3
```

1. `nginx.service` 수정

> CMD
> 

```
$ cat/lib/systemd/system/nginx.service 
[Unit]

Description=nginx - high performance web server Documentation http://nginx.org/en/docs/

After=network-online.target remote-fs.target nss-lookup.target

Wants=network-online.target

[Service]

Type=forking
PIDFile=/var/run/nginx pid

Exec Start=/usr/sbin/nginx-c/etc/nginx/nginx.conf
ExecReload-/bin/sh -c/bin/kill -s HUP $/bin/cat /var/run/nginx.pid)" 
ExecStop=/bin/sh -c "/bin/kill -s TERM $(/bin/cat /var/run/nginx.pid)"

[Install]

WantedBy-multi-user.target
```

### ※ 참고 : 현대차증권 nginx 보안설정

#### nginx 보안 관련 설정

1. nginx 띄울때 nginx 전용 계정으로 실행
 ```
 # nginx.conf
 user nginx nginxgroup;
 ```
    
2. nginx 실행하는 계정의 접근 권한 제한
 ```
 $ chown nginx:nginxgroup ./nginx_root_dir
 $ chmod 750 ./nginx_root_dir
 ```
    
3. nginx 서버 설정 파일 접근 제한
```
$ chown nginx:nginxgroup ./nginx_root_dir/conf/*.conf
$ chmod 600 ./nginx_root_dir/conf/*.conf
```
    
4. directory 검색 기능 비활성화
```
# nginx.conf
    ...
    autoindex off;
    ...
```
    
5. log file 에 대한 접근 제한
    1. nginx.config 에 설정된 log directory 확인
    ```
    $ cat ./nginx_root_dir/conf/nginx.conf | grep "error_log\\|access_log"
    ```
        
    2. default log 에 대한 접근제한
    ```
    chown nginx:nginxgroup ./nginx_root_dir/logs/
    chmod 750 ./nginx_root_dir/logs/
    chmod 640 ./nginx_root_dir/logs/*.log
    ```


6. 공격등을 파악하기 위해서 필요한 정보를 logging 해야 한다.
    - [The Default access_log Log Format](https://adamtheautomator.com/nginix-logs/#The_Default_access_log_Log_Format)

```
# nginx.conf
...
log_format combined '$remote_addr - $ remote_user [$time_local]''
            '"$request" $body_bytes_sent'
            '"$http_referer" "http_user_agent"';

access_log logs/access.log combined
```
    
7. 법적으로 log file 을 최소 1년 이상 보관해야 한다.
    1. 사용자 접속 기록 1년 이상: 사용자 로그인/로그아웃/정보변경 등(개인정보 미 취급 시 6개월 이상)
    2. 개인정보취급자의 개인정보처리시스템 접속 기록 2년 이상
        - 정보주체 식별정보 / 개인정보취급자 식별정보 /
        - 접속일시 / 접속지 정보 /
        - 부여된 권한 유형에 따른 수행업무 등 2년 이상
    3. 개인정보취급자권한 변경 기록 5년 이상
        - 개인정보취급자 권한 생성/변경/삭제 등
        - 
8. 헤더 정보 노출 방지
```
# nginx config
...
server_tokens off;
...
```
    
9. http method 제한
nginx 에서 default 로 HTTP Method 중 GET, POST, HEAD, OPTIONS 만 허용
아래처럼 dav_methods 를 설정하지 말아야 한다.(기본값: `dav_methods off`)
    
```
# nginx.conf

location / {
    root /data/www;

    dav_methods PUT DELETE MKCOL COPY MOVE;
}
```
    
10. 에러핸들링 설정 값 적용 (필수 항목 : 400, 401, 403, 404, 500)
    
```
# nginx.conf
...
error_page 400 401 403 404 500 /error.html;
...
```


#### 솔루션 취약점관련 설정

1. 기본 문서명 변경: index.html, index.htm 외의 이름으로 한다.

```
# nginx.conf

location / {
    root html;
    index example_main.html;
}
```

1. SSL 을 사용못하게 설정: POODLE 취약점 공격 방어를 위해

```
# nginx.conf
...
server {
    listen          443 ssl;
    server_name     www.example.com;
    ssl_certificate     www.example.com.crt;
    ssl_certificate_key www.example.com.key;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers     HIGH:!aNULL:!MD5;
}
...
```

호환성 이슈로 인해 SSLv3 비활성화가 불가하고, OpenSSL 버전 업그레이드 또한 불가할 경우 OpenSSL설정파일에서 CBC Cipher Suite 제거

제거해야 할 cipher suite

- TLS_DH_anon_WITH_AES_256_CBC_SHA
- TLS_DH_anon_WITH_3DES_EDE_CBC_SHA
- TLS_DH_anon_WITH_AES_128_CBC_SHA
- TLS_DH_anon_WITH_RC4_128_MD5
- TLS_DH_anon_WITH_DES_SHA

#### 권장하는 nginx 서버 version

- nginx 1.17.7 이상
- nginx 1.16.1 이상
- nginx 1.15.12 이상