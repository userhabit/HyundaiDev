---
title: "07_Nginx설치 및 보안설정"
date: 2022-04-05 07:00:00
layout: article
tag: 
- HyundaiDev
- Polaris
categories: 
- Development
- InstallGuide
published: true
sidebar:
  nav: PolarisInst_Sidebar
excerpt: 'Nginx설치 및 보안설정'
permalink: /HyundaiInst/07/
---


## Nginx설치 및 보안설정

### 1. 설치

> CMD - bash
> 

```
rpm -Uvh nginx-1.20.2-1.el8.ngx.x86_64.rpm
```

- 설치 후 nginx 가 설치, nginx 계정 생성됨, nginx.service 등록된다

### 2. 설치 확인

> CMD - bash
> 

```
systemctl status nginx
systemctl start nginx
systemctl stop nginx
```

### 3. 보안설정

- 모두 **root** 계정으로 진행필요

> CMD - bash
> 

```
# nginx:nginx (user:group) 가 존재

cat hosts >> /etc/hosts
cp nginx.conf /etc/nginx/nginx.conf

useradd nginx
usermod -s /sbin/nologin nginx

chown nginx:nginx /usr/share/nginx/html
chmod 750 /usr/share/nginx/html

chown nginx:nginx /etc/nginx/*.conf 
chmod 600 /etc/nginx/*.conf

mv /usr/share/nginx/html/index.html /usr/share/nginx/html/uh_main.html

chown nginx:nginx /var/log/nginx/
chmod 750 /var/log/nginx/ 
chmod 640 /var/log/nginx/*.log

# header filter module
cp /mceadm/install/ngx_http_headers_more_filter_module.so /etc/nginx/modules/
chmod 644 /etc/nginx/modules/ngx_http_headers_more_filter_module.so

# https 인증서
cp /mceadm/install/hmsec_pem.pem /etc/nginx/
cp /mceadm/install/hmsec_pem.key /etc/nginx/
chmod 644 /etc/nginx/hmsec_pem.pem
chmod 644 /etc/nginx/hmsec_pem.key

systemctl start nginx
systemctl status nginx
```

> CMD - ****`/etc/nginx/nginx.conf`****
> 

```
sudo usermod -aG mceadm nginx

mkdir -p /mceadm/apps/nginx/log 
mkdir -p /mceadm/apps/nginx/run 
chown nginx:nginx /mceadm/apps/nginx -R
```

```
# /etc/nginx/nginx.conf
user nginx nginx;

worker_processes auto;

error_log /mceadm/apps/nginx/log/error.log notice; 
pid /var/run/nginx.pid;

# ###############
# ngx_http_headers_more_filter_module
# ###############
load_module /etc/nginx/modules/ngx_http_headers_more_filter_module.so;

events { 
  worker_connections 1024; 
}

http{

  include         /etc/nginx/mime.types; 
  default_type application/octet-stream;

  # ###############
  # ngx_http_headers_more_filter_module
  # ###############
  more_set_headers 'Server: Userhabit';
  more_set_headers 'X-Powered-By: Userhabit, Inc.';

  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                ' ""$http_user_agent" "$http_x_forwarded_for"';

  access_log /mceadm/apps/nginx/log/access.log main;

  sendfile on; 
  #tcp_nopush on;

  keepalive_timeout 65;

  #gzip on;
  
  client_max_body_size 50m;

  include /etc/nginx/conf.d/*.conf;

  server {
    listen 90;
    return 301 https://mceex.hmsec.com; # 개발서버는 mceext.hmsec.com
  }
  server {
    # ####################
    # 수정필요 : 추후 domain 이 설정되면 변경
    # ####################
    listen 443 ssl;
    server_name mceex.hmsec.com; # 개발서버는 mceext.hmsec.com
    ssl_certificate /etc/nginx/hmsec_pem.pem; 
    ssl_certificate /etc/nginx/hmsec_pem.key
    ssl_protocols TLSV1 TLSv1.1 TLSV1.2; 
    ssl_ciphers HIGH:!aNULL:!MD5;

    # listen 80;
    # server_name localtest

    #hmse 
    server_tokens off;
    
    error_page 400 401 403 404 500 502 503 504 /50x.html;
    location / { 
      root /usr/share/nginx/html;  
      index uh_main.html uh_main.htm;

      autoindex off;

      dav_methods PUT DELETE MKCOL COPY MOVE;

    }

    location /v3 {
      proxy_pass http://polaris;
    }
    location /v2 {
     proxy_pass http://polaris;

    }

  } 

  upstream polaris {
    # ####################
    # 수정필요 : 추후 dmz 에서 현대차증권 local gateway 가 열리면 변경
    # ####################
    server uhs1.userhabit.io:8080;
    server uhs2.userhabit.io:8080;
    server uhs3.userhabit.io:8080;
    # server 127.0.0.1:8080;
  }
}
```

> CMD - ****`/etc/hosts`****
> 

```
...
10.227.171.96 uhs1.userhabit.io
10.227.171.97 uhs2.userhabit.io
10.227.171.98 uhs3.userhabit.io
```

### 4. 테스트

> CMD - bash
> 

```
python3 -m http.server 8080
```

```
curl localhost
curl localhost/v3
```

> CMD - `nginx.service`
> 

```
$ cat/lib/systemd/system/nginx.service 
[Unit]

Description=nginx - high performance web server Documentation http://nginx.org/en/docs/

After=network-online.target remote-fs.target nss-lookup.target

Wants=network-online.target

[Service]

Type=forking
PIDFile=/var/run/nginx pid

Exec Start=/usr/sbin/nginx-c/etc/nginx/nginx.conf
ExecReload-/bin/sh -c/bin/kill -s HUP $/bin/cat /var/run/nginx.pid)" 
ExecStop=/bin/sh -c "/bin/kill -s TERM $(/bin/cat /var/run/nginx.pid)"

[Install]

WantedBy-multi-user.target
```

### 5. 기타

- 상황
    - 도메인, 방화벽 설정 완료 후 동작 확인
- 확인사항
    - 아래 주소로 web browser 를 이용해서 접속하면 404 not found 가 뜨면 된다.
        - [https://mceex_t.hmsec.com/](https://mceex_t.hmsec.com/)
        - [https://mceex_t.hmsec.com/v3](https://mceex_t.hmsec.com/v3) : 현재 url 에 /v3 가 들어가면 proxy_pass 가 되도록 설정이 되어 있는데 ,이부분도 확인됨. 확인방법은 127.0.0.1:8080 으로 보내고, local 에 간단한 static server 띄워서 확인함. 참고로 error log 를 봐도 proxy_pass 가 적용된 url 을 확인할 수 있다.
    - nginx 동작확인
        - [https://mceex_t.hmsec.com/](https://mceex_t.hmsec.com/) 으로 접속가능
        - 현재 round robin 으로 `https://mceex_t.hmsec.com/v3` 에 접근하면, 3개의 WAS 들에 번갈아 가면서 request 를 분배시켜준다.
        - 현재 [https://mceex_t.hmsec.com/](https://mceex_t.hmsec.com/) 로 접속하면 nginx welcome 이 보인다. 이부분은 수정해야 할 수 있다.
        - 현재, `https://mceex_t.hmsec.com/Login` 을 호출하면 `/usr/share/nginx/html/Login` 에 접근을 시도한다.
    - 추가 요청사항
        - error 시 error page 외의 화면으로 하나 넣어달라. --> 완료 [https://mceex_t.hmsec.com/v1](https://mceex_t.hmsec.com/v1)
